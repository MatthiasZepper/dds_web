<!-- Gives same logo etc as index.html -->
{% extends "home.html" %}

<!-- Adds back button to side nav bar -->
{% block back_button %}
  <a href="{{ reverse_url('home') }}">Back</a>
{% end %}

{% block content %}
<br><br>

<!-- All files and associated information in current project -->
<div class="container">
  <h3 align="center">Project: {{ curr_project['name'] }}</h3>
  <br>
  <!-- Project description area -->
  <div class="container" align="center">
    {{ curr_project['description'] }}
  </div>
  <br><br>

  <!-- Button to close add-file-div.
  Visible when "add files" button is pressed on home page or project page -->
  <button id="collapse-button-exit" data-toggle="collapse"
    data-target="#addfiles_div"
    style="{% if addfiles %}display:block;{% else %}display:none;{% end %}"
    onclick="switchVisible();" class="btn btn-primary pull-left">
      Exit file edit view
  </button>
  <br><br>

  <!-- File upload -->
  <div id="addfiles_div" class="row container collapse pull-left {% if addfiles %}in{% else %}{% end %}">
    <form action="{{ reverse_url('upload', projid) }}" method="post" enctype="multipart/form-data">
      {% module xsrf_form_html() %}
      <div class="newfiles">
        <input name="filesToUpload" id="filesToUpload" type="file" multiple/>
      </div>
      <div class="newfiles">
        <input type="submit" name="submit" value="Upload File(s)"/>
      </div>
    </form>
    <output id="list"></output>
  </div>
  <br><br><br>

  <!-- Main content: Project info and files -->
  <div class="row">
    <!-- Project information area (left) -->
    <div class="col-sm-4">
      <table>
          <tr>
            <th>Order ID:</th>   <td>{{ projid }}</td>
          </tr>
          <tr>
            <th>Order date:</th>  <td>{{ curr_project['order_date'] }}</td>
          </tr>
          {% if curr_project['status'] == "Uploaded" %}
            <tr>
              <th>Final delivery date:</th> <td></td>
            </tr>
          {% else %} <!-- if curr_project['status'] == "Uploaded" -->
            <tr>
              <th>Status:</th>  <td>{{ curr_project['status'] }}</td>
            </tr>
          {% end %} <!-- if curr_project['status'] == "Uploaded" -->
          <tr>
            <th>Project category:</th>  <td>{{ curr_project['category'] }}</td>
          </tr>
          <tr>
            <th>Sensitive:</th> <td>{% if curr_project['sensitive'] == "True" %} Yes {% else %} No {% end %}</td>
          </tr>
          <tr>
            <th>PI:</th>  <td>{{ curr_project['pi'] }}</td>
          </tr>
          <br>
      </table>
      <br>
      <br>
      <table class="comments">
        <tr>
          <th>Comments/Information:</th>
        </tr>
        <tr>
          <td>{{ curr_project['comments'] }}</td>
        </tr>
      </table>
    </div>
    <!-- File area (right) -->
    <div class="col-sm-7 pull-right">
      {% if files != {} %}
        <div class="row">
          <div>
            <table id="files">
              <thead>
                <tr>
                  <th>File name</th>
                  <th>Format</th>
                  <th>Size</th>
                  <th>Date Uploaded</th>
                  <th>Download</th>
                </tr>
              </thead>
              <tbody>
                {% for f in files %}
                  <tr>
                    <td>{{ f }}</td>
                    <td>{{ files[f]['format'] }}</td>
                    <td>{{ files[f]['size'] }}</td>
                    <td>{{ files[f]['date_uploaded'] }}</td>
                    <td>
                      <button class="btn" id="{{ f }}"><i class="fa fa-download" align="center"></i></button>
                    </td>
                  </tr>
                {% end %} <!-- for f in files -->
              </tbody>
            </table>
          </div>
          <div>
            <!-- Download all button -->
            <button class="btn btn-default btn-block" style="align:center;">Download all</button>
          </div>
        </div>
      {% else %} <!-- if files != {} -->
        <p>This project does not contain any uploaded files.</p>
      {% end %} <!-- if files != {} -->
    </div>
  </div>
  <br><br>
  <!-- End main content -->

  <!-- Buttons (finished or add files) -->
  <div class="row">
    <div class="col-sm-6">
        <form action="{{ reverse_url('status', projid) }}" method="POST">
          {% module xsrf_form_html() %}
          {% if curr_project['status'] == "Uploaded" %}
            <button name="setasopen" class="btn btn-primary pull-left submit">Open project</button>
          {% else %} <!-- if curr_project['status'] == "Uploaded" -->
            <button name="setasfinished" class="btn btn-primary pull-left submit">Mark project as finished</button>
          {% end %} <!-- if curr_project['status'] == "Uploaded" -->
        </form>
    </div>

    <!-- Add files button - opens collapsible -->
    <div class="col-sm-6">
      <button id="collapse-button-add" data-toggle="collapse"
        data-target="#addfiles_div"
        style="{% if addfiles %}display:none;{% else %}display:block;{% end %}"
        onclick="switchVisible();" class="btn btn-primary pull-right">
          Add files
      </button>
    </div>
  </div>
</div>
<br><br>

<!-- JAVASCRIPT -->
<script>
  // Makes DataTable (pagination etc)
  $(document).ready(function() {
    $('#files').DataTable( {
      responsive: true,
      paging: true
    })
  })

  // Check for the various File API support.
  if (window.File && window.FileReader && window.FileList && window.Blob) {
  // Great success! All the File APIs are supported.
  } else {
    alert('The File APIs are not fully supported in this browser.');
  }

  // Display chosen files
  function handleFileSelect(evt) {
    var files = evt.target.files;

    var output = [];
    for (var i=0, f; f=files[i]; i++) {
      output.push('<tr>',
                    '<td>', escape(f.name), '</td>',
                    '<td>', f.type || 'n/a', '</td>',
                    '<td>', f.size, ' bytes </td>',
                    '<td>', f.lastModifiedDate ? f.lastModifiedDate.toLocalDateString() : 'n/a', '</td>',
                  '</tr>');
    }
    document.getElementById('list').innerHTML = '<table>' +
                                                  '<thead>' +
                                                    '<tr>' +
                                                      '<th>File name</th>' +
                                                      '<th>Format</th>' +
                                                      '<th>Size</th>' +
                                                      '<th>Last modified</th>' +
                                                    '</tr>' +
                                                  '</thead>' +
                                                  '<tbody>' +
                                                    output.join('') +
                                                  '</tbody>' +
                                                '</table>';
  }
  document.getElementById('filesToUpload').addEventListener('change', handleFileSelect, false);

  // Show/hide "add files"/"exit file view" button
  function switchVisible() {
    if (document.getElementById('collapse-button-add')) {
      if (document.getElementById('collapse-button-add').style.display == 'none') {
        document.getElementById('collapse-button-add').style.display = 'block';
        document.getElementById('collapse-button-exit').style.display = 'none';
      }
      else {
        document.getElementById('collapse-button-add').style.display = 'none';
        document.getElementById('collapse-button-exit').style.display = 'block';
      }
    }
  }

</script>

{% end %}
