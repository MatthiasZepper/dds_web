{% extends 'base.html' %}

{% block body %}

<h1 class="mb-4"><span class="badge bg-light text-muted border">{{ project.public_id }}</span> {{ project.title }}</h1>
<table class="table table-hover">
    <tbody>
        <tr>
            <th>Project ID</th>
            <td>{{ project.public_id }}</td>
        </tr>
        <tr>
            <th>Description</th>
            <td>{{ project.description }}</td>
        </tr>
        <tr>
            <th>Category</th>
            <td>{{ project.category }}</td>
        </tr>
        <tr>
            <th>Users</th>
            <td><code>{{ project.users }}</code></td>
        </tr>
        <tr>
            <th>Facility</th>
            <td>{{ project.facility_name }}</td>
        </tr>
        <tr>
            <th>Status</th>
            <td>{{ project.status }}</td>
        </tr>
        <tr>
            <th>Creation date</th>
            <td>{{ project.date_created }}</td>
        </tr>
        {% if project.date_updated %}
        <tr>
            <th>Delivery date</th>
            <td>{{ project.date_updated }}</td>
        </tr>
        <tr>
            <th>Data size</th>
            <td>{{ project.size }}</td>
        </tr>
        {% endif %}
    </tbody>
</table>

{% if g.is_facility %}

<h2 class="mt-5 mb-4">Upload Files</h2>
<div class="alert alert-danger d-none" id="noDataTransfer_warning">
    <strong>Warning:</strong> Your web browser does not support the
    <a href="https://developer.mozilla.org/en-US/docs/Web/API/DataTransfer" target="_blank"><code>DataTransfer</code></a>
    web API. Directory file paths of uploads cannot not be maintained.
    Please try using a newer browser or the <code>dds</code> command line client.
</div>
<div id="dropDiv" class="p-4 mb-3 bg-light border text-muted">
    <span id="upload_file_instructions">Drag & drop your files here!</span>
    <div id="upload_file_list"></div>
    <div id="upload_file_progress" class="progress d-none">
        <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
    </div>
</div>
<button id="upload_file_btn" class="btn btn-primary">
    <i class="far fa-cloud-upload me-2"></i> Upload
</button>
<span id="upload_file_msg" class="ms-3 p-1 d-none"></span>
{% endif %}

<h2 class="mt-5 mb-4">Project Files</h2>

{% if uploaded_data %}

{% if not g.is_facility %}

{% if project.unformated_size <= download_limit %}
<a href="{{ url_for('project.data_download', project_id=project.public_id) }}" class="btn btn-primary btn-custom
    float-end">
    <i class="fas fa-download me-2"></i> Download all
</a>
{% else %}
<div class="alert alert-info" role="alert">
    This project is too large to be downloaded via a web browser (over {{format_size(download_limit) }}).
    Files / folders that are under the threshold can be downloaded individually.
    Alternatively, Please use the <code>dds_cli</code> command line tool, available here:
    <a href="https://github.com/scilifelabdataCentre/dds_cli">https://github.com/scilifelabdataCentre/dds_cli</a>
</div>
{% endif %}

{% endif %}

<div id="uploaded-file-list">{{ uploaded_data | safe }}</div>

{% else %}

<div class="alert alert-light border">
    No files found.
</div>

{% endif %}

{% endblock %}



{% block javascript %}
<script type="text/javascript">
$(function () {
    // Toggle the folder icon when opening / closing
    $('.folder').click(function () {
        $(this).children('.folder-icon').toggleClass('fa-folder, fa-folder-open');
    });
});

{% if g.is_facility %}

// Variable to hold file objects to upload
upload_files = {};

// Filenames to ignore
ignore_files = [
    '.DS_Store'
]

// Upload files drag + drop
document.addEventListener('DOMContentLoaded', function(event) {

    dropArea = document.getElementById('dropDiv');

    // Prevent all default behaviour for drag + drop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, function(e){
            e.preventDefault();
            e.stopPropagation();
        }, false);
    });

    // Highlight + unhighlight when dragging over
    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, function(e){
            document.getElementById('dropDiv').classList.add("border-primary");

            // Just in case we had an upload already - show everything again
            $('#upload_file_list, #upload_file_instructions').removeClass('d-none');
            $('#upload_file_progress').addClass('d-none');
            $('#upload_file_msg').text('').removeClass('bg-danger');
            $('#upload_file_progress div').css('width', 0).text('').removeClass('bg-danger bg-success');
        }, false);
    });
    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, function(e){
            document.getElementById('dropDiv').classList.remove("border-primary");
        }, false);
    });

    // Action to stage files when dropped
    dropArea.addEventListener('drop', function (e) {

        // Thanks to https://stackoverflow.com/a/51150691/713980
        function addFiles(e){
            // if directory support is available
            if(e.dataTransfer && e.dataTransfer.items){
                var items = e.dataTransfer.items;
                for (var i=0; i<items.length; i++) {
                    var item = items[i].webkitGetAsEntry();
                    if (item) {
                        addDirectory(item);
                    }
                }
                return;
            }
            // We could offer some Fallback support here,
            // but this will only be used by a limited number of users
            // so it's probably ok to keep the code simple and insist
            // on new browsers or using the cli tool.
            $('#noDataTransfer_warning').removeClass('d-none');
            $('#dropDiv').addClass('d-none');
            $('#upload_file_btn').attr('disabled', true);
            return;
        }

        function addDirectory(item) {
            if (item.isDirectory) {
                var directoryReader = item.createReader();
                directoryReader.readEntries(function(entries) {
                    entries.forEach(function(entry) {
                        addDirectory(entry);
                    });
                });
            } else {
                item.file(function(file){
                    if(ignore_files.indexOf(file.name) >= 0){
                        console.log("Skipping file as matched filename ignore pattern: "+item.fullPath);
                    } else {
                        $('#upload_file_list').append('<div class="upload_file"><code>'+item.fullPath+'</code></div>');
                        upload_files[item.fullPath] = file;
                    }
                });
            }
        }

        // Call the function
        addFiles(e);

    }, false);

    // Upload files
    $('#upload_file_btn').click(function(e){
        e.preventDefault();

        // Hide the file list and show the progress bar
        $('#upload_file_list, #upload_file_instructions').addClass('d-none');
        $('#upload_file_progress').removeClass('d-none');

        // Build the FormData object
        let formData = new FormData();
        formData.append('project_id', '{{ project.public_id }}');
        for(path in upload_files){
            formData.append('files', upload_files[path]);
            formData.append('file_paths', path);
        }

        // Send
        // Note that we can't use 'fetch' yet as we want upload progress
        let xhr = new XMLHttpRequest();

        // track upload progress
        xhr.upload.onprogress = function(e) {
            let pct = (e.loaded/e.total)*100.0+'%';
            $('#upload_file_progress div').css('width', pct).text(pct);
        };

        // track completion: both successful or not
        xhr.onloadend = function() {
            data = JSON.parse(this.response);
            $('#upload_file_msg').text(data.message).removeClass('d-none');
            $('#upload_file_progress div').css('width', '100%').removeClass('progress-bar-animated');
            if (xhr.status == 200) {
                $('#upload_file_msg').addClass('text-success').removeClass('bg-danger text-white');
                $('#upload_file_progress div').addClass('bg-success');
            } else {
                $('#upload_file_msg').addClass('bg-danger text-white').removeClass('text-success').prepend('<strong>Error: </strong>');
                $('#upload_file_progress div').addClass('bg-danger');
            }

            // Reset
            upload_files = [];
            $('#upload_file_list').html('');
        };

        xhr.open("POST", "{{ url_for('project.data_upload') }}");
        xhr.send(formData);

    });
});

{% endif %}

</script>
{% endblock %}
